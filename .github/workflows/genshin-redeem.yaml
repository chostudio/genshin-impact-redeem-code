name: Monthly Genshin Code Redeemer

on:
  schedule:
    # Runs at 00:00 on the 1st of every month
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  redeem-codes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        # Optimizes install by skipping heavy browser binaries
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
        run: npm install

      - name: Run Anchor Browser Automation
        env:
          # We map the secret to the specific env var expected by the script
          ANCHOR_BROWSER_KEY: ${{ secrets.ANCHOR_BROWSER_KEY }}
          GENSHIN_EMAIL: ${{ secrets.GENSHIN_EMAIL }}
          GENSHIN_PASSWORD: ${{ secrets.GENSHIN_PASSWORD }}
        run: |
          # 1. Create a session via the correct API endpoint
          # Using -s (silent) to hide progress bar, but -S (show error) if it fails
          RESPONSE=$(curl -s -S -X POST "https://api.anchorbrowser.io/v1/sessions" \
            -H "Content-Type: application/json" \
            -H "anchor-api-key: $ANCHOR_BROWSER_KEY" \
            -d '{}')

          # 2. Extract Session ID
          SESSION_ID=$(echo "$RESPONSE" | jq -r '.id')

          # 3. Validation & Execution
          if [ "$SESSION_ID" == "null" ] || [ -z "$SESSION_ID" ]; then
            echo "❌ Failed to create session."
            echo "API Response: $RESPONSE"
            exit 1
          else
            echo "✅ Created Session: $SESSION_ID"
            node index.mjs "$SESSION_ID"
          fi